import imaplib
import email
import time
import os

# Cấu hình Gmail
GMAIL_USER = "thaogucci123@gmail.com"
GMAIL_PASSWORD = "crhm isws vmom vqfs"  # Sử dụng App Password nếu dùng Gmail
IMAP_SERVER = "imap.gmail.com"
SIGNAL_FILE = "C:\\Users\\DELL\\AppData\\Roaming\\MetaQuotes\\Terminal\\53785E099C927DB68A545C249CDBCE06\\MQL5\\Files\\signals.txt"

def extract_signal_from_email():
    try:
        mail = imaplib.IMAP4_SSL(IMAP_SERVER)
        mail.login(GMAIL_USER, GMAIL_PASSWORD)
        mail.select("inbox")

        # Chỉ tìm email chưa đọc từ TradingView
        status, messages = mail.search(None, '(UNSEEN FROM "noreply@tradingview.com")')
        if status != "OK" or not messages[0]:
            print("Không có email mới từ TradingView")
            return None

        message_ids = messages[0].split()
        latest_email_id = message_ids[-1]  # Lấy email mới nhất
        status, msg_data = mail.fetch(latest_email_id, "(RFC822)")
        email_message = email.message_from_bytes(msg_data[0][1])

        # Trích xuất nội dung email
        signal = None
        if email_message.is_multipart():
            for part in email_message.walk():
                if part.get_content_type() == "text/plain":
                    body = part.get_payload(decode=True).decode('utf-8', errors='ignore').strip()
                    signal = extract_signal(body)
                    break
        else:
            body = email_message.get_payload(decode=True).decode('utf-8', errors='ignore').strip()
            signal = extract_signal(body)

        # Đánh dấu email là đã đọc để không xử lý lại
        mail.store(latest_email_id, "+FLAGS", "\\Seen")
        mail.logout()

        return signal

    except Exception as e:
        print(f"Lỗi khi kiểm tra email: {e}")
        return None

def extract_signal(text):
    """Trích xuất tín hiệu từ nội dung email."""
    text_upper = text.upper()
    valid_signals = ["BUY", "SELL", "EXIT BUY", "EXIT SELL"]
    for signal in valid_signals:
        if signal in text_upper:
            return signal
    return None

def main():
    while True:
        signal = extract_signal_from_email()
        if signal:
            with open(SIGNAL_FILE, "w", encoding='utf-8') as file:
                file.write(signal)
            print(f"Tín hiệu '{signal}' đã được ghi vào {SIGNAL_FILE}")
        time.sleep(1)  # Kiểm tra mỗi 60 giây

if __name__ == '__main__':
    main()